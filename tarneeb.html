<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒ ØªØ­Ø¯ÙŠØ§Øª Ø·Ø±Ù†ÙŠØ¨</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #d69e2e;
            --secondary: #ed8936;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ecc94b;
            --dark: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 42px;
            color: var(--primary);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 18px;
            color: #cbd5e0;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .friend-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .friend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(214, 158, 46, 0.4);
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .friend-email {
            font-size: 13px;
            color: #718096;
        }

        .friend-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-play {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(214, 158, 46, 0.4);
        }

        .btn-team {
            background: linear-gradient(135deg, var(--success), #38a169);
            color: white;
        }

        .btn-team:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-vs {
            background: linear-gradient(135deg, var(--danger), #e53e3e);
            color: white;
        }

        .btn-vs:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #a0aec0;
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .challenge-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .challenge-info {
            color: var(--dark);
        }

        .challenge-info h4 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .challenge-info p {
            font-size: 14px;
            color: #718096;
        }

        .challenge-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef5e7;
            color: #d68910;
        }

        .status-playing {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .challenge-actions {
            display: flex;
            gap: 10px;
        }

        .challenge-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-accept {
            background: var(--success);
            color: white;
        }

        .btn-reject {
            background: var(--danger);
            color: white;
        }

        .btn-continue {
            background: var(--primary);
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 32px;
            }

            .friends-grid {
                grid-template-columns: 1fr;
            }

            .friend-actions {
                flex-direction: column;
            }

            .action-btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-right"></i>
        Ø±Ø¬ÙˆØ¹
    </a>

    <div class="container">
        <div class="header">
            <h1>ğŸƒ ØºØ±Ù Ø·Ø±Ù†ÙŠØ¨</h1>
            <p>Ø§Ù„Ø¹Ø¨ Ø·Ø±Ù†ÙŠØ¨ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ø£Ùˆ Ø§Ù„Ø¨ÙˆØªØ§Øª</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('friends')">
                ğŸ‘¥ Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ
            </button>
            <button class="tab-btn" onclick="switchTab('rooms')">
                ğŸ® ØºØ±ÙÙŠ
            </button>
        </div>

        <!-- Friends Tab -->
        <div id="friends-tab">
            <div id="friends-loading" class="loading">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡...</p>
            </div>
            <div id="friends-grid" class="friends-grid" style="display: none;"></div>
            <div id="friends-empty" class="empty-state" style="display: none;">
                <i class="fas fa-user-slash"></i>
                <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
                <p>Ø£Ø¶Ù Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠÙ‡Ù… ÙÙŠ Ø§Ù„Ø·Ø±Ù†ÙŠØ¨</p>
            </div>
        </div>

        <!-- Rooms Tab -->
        <div id="rooms-tab" style="display: none;">
            <div id="rooms-loading" class="loading">
                <div class="spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...</p>
            </div>
            <div id="rooms-list" style="display: none;"></div>
            <div id="rooms-empty" class="empty-state" style="display: none;">
                <i class="fas fa-door-open"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù†Ø´Ø·Ø©</h3>
                <p>Ø§Ø¯Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="firebase-data.js"></script>

    <script>
        let currentUser = null;
        let me = null;
        let currentTab = 'friends';

        // Check authentication
        firebase.auth().onAuthStateChanged(function(user) {
            if (!user) {
                location.href = "login.html";
                return;
            }
            
            currentUser = user;
            loadUserData();
            listenForInvites();
        });

        function listenForInvites() {
            firebase.database().ref('users/' + currentUser.uid + '/tarneebInvites').on('child_added', snapshot => {
                const invite = snapshot.val();
                if (invite && !invite.read) {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
                    if (Notification.permission === "granted") {
                        new Notification("Ø¯Ø¹ÙˆØ© Ø·Ø±Ù†ÙŠØ¨ Ø¬Ø¯ÙŠØ¯Ø©", {
                            body: `${invite.fromName} ÙŠØ¯Ø¹ÙˆÙƒ Ù„Ù„Ø¹Ø¨!`,
                            icon: 'icon.png' // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
                        });
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") {
                                new Notification("Ø¯Ø¹ÙˆØ© Ø·Ø±Ù†ÙŠØ¨ Ø¬Ø¯ÙŠØ¯Ø©", {
                                    body: `${invite.fromName} ÙŠØ¯Ø¹ÙˆÙƒ Ù„Ù„Ø¹Ø¨!`
                                });
                            }
                        });
                    }
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    const accept = confirm(`${invite.fromName} ÙŠØ¯Ø¹ÙˆÙƒ Ù„Ù„Ø¹Ø¨ Ø·Ø±Ù†ÙŠØ¨. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…ØŸ`);
                    if (accept) {
                        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆØ©
                        snapshot.ref.update({ read: true });
                        location.href = `room-tarneeb.html?room=${invite.roomId}`;
                    }
                }
            });
        }

        function loadUserData() {
            firebase.database().ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    me = snapshot.val();
                    me.id = currentUser.uid;
                    loadFriends();
                })
                .catch(err => {
                    console.error("Error loading user:", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide tabs
            if (tab === 'friends') {
                document.getElementById('friends-tab').style.display = 'block';
                document.getElementById('rooms-tab').style.display = 'none';
                loadFriends();
            } else {
                document.getElementById('friends-tab').style.display = 'none';
                document.getElementById('rooms-tab').style.display = 'block';
                loadRooms();
            }
        }

        function loadFriends() {
            const loading = document.getElementById('friends-loading');
            const grid = document.getElementById('friends-grid');
            const empty = document.getElementById('friends-empty');

            loading.style.display = 'block';
            grid.style.display = 'none';
            empty.style.display = 'none';

            getAllUsers().then(allUsers => {
                const friends = me.friends || [];

                if (friends.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                const friendsData = friends.map(fid => {
                    return allUsers.find(u => String(u.id) === String(fid));
                }).filter(f => f);

                if (friendsData.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }

                displayFriends(friendsData);
                loading.style.display = 'none';
                grid.style.display = 'grid';
            }).catch(err => {
                console.error("Error loading friends:", err);
                loading.style.display = 'none';
                empty.style.display = 'block';
            });
        }

        function displayFriends(friends) {
            const grid = document.getElementById('friends-grid');
            grid.innerHTML = '';

            friends.forEach(friend => {
                const friendName = friend.name || friend.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                const friendEmail = friend.email || '';

                const card = document.createElement('div');
                card.className = 'friend-card';
                card.innerHTML = `
                    <div class="friend-header">
                        <div class="friend-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friendName}</div>
                            <div class="friend-email">${friendEmail}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn btn-team" onclick="inviteFriend('${friend.id}', '${friendName}')">
                            <i class="fas fa-paper-plane"></i>
                            Ø¯Ø¹ÙˆØ© Ù„Ù„Ø¹Ø¨
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function inviteFriend(friendId, friendName) {
            // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
            const roomId = 'TR_tarneeb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const roomData = {
                id: roomId,
                name: `Ø·Ø±Ù†ÙŠØ¨ - ${me.name || me.username}`,
                gameType: 'tarneeb',
                maxRounds: 1,
                status: 'waiting',
                creatorId: currentUser.uid,
                creatorName: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                players: [{
                    id: currentUser.uid,
                    username: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                    name: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                    score: 0,
                    ready: false,
                    team: 0
                }],
                invitedPlayers: [friendId],
                isPrivate: true,
                createdAt: Date.now(),
                type: 'tarneeb'
            };

            // Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firebase
            firebase.database().ref('rooms/' + roomId).set(roomData)
                .then(() => {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ© Ù„Ù„ØµØ¯ÙŠÙ‚
                    const inviteData = {
                        type: 'tarneeb_invite',
                        from: currentUser.uid,
                        fromName: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                        to: friendId,
                        roomId: roomId,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    return firebase.database().ref('users/' + friendId + '/tarneebInvites/' + roomId).set(inviteData);
                })
                .then(() => {
                    alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù€ ${friendName}`);
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØºØ±ÙØ©
                    location.href = `room-tarneeb.html?room=${roomId}`;
                })
                .catch(err => {
                    console.error("Error sending invite:", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©");
                });
        }

        function loadRooms() {
            const loading = document.getElementById('rooms-loading');
            const list = document.getElementById('rooms-list');
            const empty = document.getElementById('rooms-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            // Ø¬Ù„Ø¨ Ø§Ù„ØºØ±Ù Ø§Ù„ØªÙŠ Ø£Ù†Ø´Ø£Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù…Ø¯Ø¹Ùˆ Ø¥Ù„ÙŠÙ‡Ø§
            firebase.database().ref('rooms').orderByChild('type').equalTo('tarneeb').once('value')
                .then(snapshot => {
                    const rooms = [];
                    snapshot.forEach(child => {
                        const room = child.val();
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØºØ±Ù Ø§Ù„ØªÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠÙ‡Ø§ Ø£Ùˆ Ù…Ø¯Ø¹Ùˆ Ø¥Ù„ÙŠÙ‡Ø§
                        const isInRoom = room.players && room.players.some(p => String(p.id) === String(me.id));
                        const isInvited = room.invitedPlayers && room.invitedPlayers.includes(me.id);
                        
                        if ((isInRoom || isInvited) && room.status === 'waiting') {
                            rooms.push(room);
                        }
                    });

                    if (rooms.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }

                    displayRooms(rooms);
                    loading.style.display = 'none';
                    list.style.display = 'block';
                })
                .catch(err => {
                    console.error("Error loading rooms:", err);
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                });
        }

        function displayRooms(rooms) {
            const list = document.getElementById('rooms-list');
            list.innerHTML = '';

            rooms.forEach(room => {
                const playersCount = room.players ? room.players.length : 0;
                const isCreator = String(room.creatorId) === String(me.id);
                
                const card = document.createElement('div');
                card.className = 'friend-card';
                card.innerHTML = `
                    <div class="friend-header">
                        <div class="friend-avatar">
                            <i class="fas fa-door-open"></i>
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${room.name || 'ØºØ±ÙØ© Ø·Ø±Ù†ÙŠØ¨'}</div>
                            <div class="friend-email">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${playersCount}/4</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn btn-team" onclick="joinRoom('${room.id}')">
                            <i class="fas fa-sign-in-alt"></i>
                            ${isCreator ? 'Ø¯Ø®ÙˆÙ„' : 'Ø§Ù†Ø¶Ù…Ø§Ù…'}
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function joinRoom(roomId) {
            location.href = `room-tarneeb.html?room=${roomId}`;
        }

        function getAllUsers() {
            return firebase.database().ref('users').once('value')
                .then(snapshot => {
                    const users = [];
                    snapshot.forEach(child => {
                        const user = child.val();
                        user.id = child.key;
                        users.push(user);
                    });
                    return users;
                });
        }
    </script>
</body>
</html>
            // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª
            const roomId = 'TR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const roomData = {
                id: roomId,
                name: `Ø·Ø±Ù†ÙŠØ¨ - ${me.name || me.username} vs ${friendName}`,
                gameType: 'tarneeb',
                maxRounds: 1,
                status: 'waiting',
                creatorId: currentUser.uid,
                creatorName: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                players: [{
                    id: currentUser.uid,
                    username: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                    name: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                    score: 0,
                    ready: false,
                    team: mode === 'team' ? 0 : 0
                }],
                invitedPlayers: [friendId],
                isPrivate: true,
                mode: mode,
                createdAt: Date.now()
            };

            // Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firebase
            firebase.database().ref('rooms/' + roomId).set(roomData)
                .then(() => {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ© Ù„Ù„ØµØ¯ÙŠÙ‚
                    const inviteData = {
                        type: 'tarneeb_invite',
                        from: currentUser.uid,
                        fromName: me.name || me.username || 'Ù„Ø§Ø¹Ø¨',
                        to: friendId,
                        roomId: roomId,
                        mode: mode,
                        timestamp: Date.now(),
                        read: false
                    };
                    
                    return firebase.database().ref('users/' + friendId + '/tarneebInvites/' + roomId).set(inviteData);
                })
                .then(() => {
                    alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù€ ${friendName}`);
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØºØ±ÙØ©
                    location.href = `room-tarneeb.html?room=${roomId}`;
                })
                .catch(err => {
                    console.error("Error sending invite:", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©");
                });
        }

        function loadChallenges() {
            const loading = document.getElementById('challenges-loading');
            const list = document.getElementById('challenges-list');
            const empty = document.getElementById('challenges-empty');

            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';

            firebase.database().ref(`users/${currentUser.uid}/tarneebChallenges`).once('value')
                .then(snapshot => {
                    const challenges = [];
                    snapshot.forEach(child => {
                        challenges.push(child.val());
                    });

                    if (challenges.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }

                    displayChallenges(challenges);
                    loading.style.display = 'none';
                    list.style.display = 'block';
                })
                .catch(err => {
                    console.error("Error loading challenges:", err);
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                });
        }

        function displayChallenges(challenges) {
            const list = document.getElementById('challenges-list');
            list.innerHTML = '';

            challenges.sort((a, b) => b.createdAt - a.createdAt);

            challenges.forEach(challenge => {
                const isReceiver = String(challenge.to) === String(currentUser.uid);
                const opponentName = isReceiver ? challenge.fromName : challenge.toName;
                const modeText = challenge.mode === 'team' ? 'ğŸ‘¥ Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø¹Ø§Ù‹' : 'âš”ï¸ Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø¨Ø¹Ø¶';
                
                const card = document.createElement('div');
                card.className = 'challenge-card';
                
                let actionsHTML = '';
                if (challenge.status === 'pending' && isReceiver) {
                    actionsHTML = `
                        <div class="challenge-actions">
                            <button class="challenge-btn btn-accept" onclick="acceptChallenge('${challenge.id}')">
                                <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„
                            </button>
                            <button class="challenge-btn btn-reject" onclick="rejectChallenge('${challenge.id}')">
                                <i class="fas fa-times"></i> Ø±ÙØ¶
                            </button>
                        </div>
                    `;
                } else if (challenge.status === 'playing') {
                    actionsHTML = `
                        <div class="challenge-actions">
                            <button class="challenge-btn btn-continue" onclick="continueGame('${challenge.id}')">
                                <i class="fas fa-play"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø¹Ø¨
                            </button>
                        </div>
                    `;
                }

                const statusText = challenge.status === 'pending' ? 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 
                                 challenge.status === 'playing' ? 'Ø¬Ø§Ø±ÙŠØ©' : 'Ø§Ù†ØªÙ‡Øª';
                const statusClass = challenge.status === 'pending' ? 'status-pending' : 
                                  challenge.status === 'playing' ? 'status-playing' : '';

                card.innerHTML = `
                    <div class="challenge-header">
                        <div class="challenge-info">
                            <h4>${isReceiver ? 'ØªØ­Ø¯ÙŠ Ù…Ù†' : 'ØªØ­Ø¯ÙŠØª'} ${opponentName}</h4>
                            <p>${modeText}</p>
                        </div>
                        <div class="challenge-status ${statusClass}">${statusText}</div>
                    </div>
                    ${actionsHTML}
                `;
                
                list.appendChild(card);
            });
        }

        function acceptChallenge(challengeId) {
            // Update challenge status
            const updates = {};
            updates[`users/${currentUser.uid}/tarneebChallenges/${challengeId}/status`] = 'playing';
            
            // Get opponent ID
            firebase.database().ref(`users/${currentUser.uid}/tarneebChallenges/${challengeId}`).once('value')
                .then(snapshot => {
                    const challenge = snapshot.val();
                    const opponentId = String(challenge.from) === String(currentUser.uid) ? challenge.to : challenge.from;
                    
                    updates[`users/${opponentId}/tarneebChallenges/${challengeId}/status`] = 'playing';
                    
                    return firebase.database().ref().update(updates);
                })
                .then(() => {
                    // Get challenge details and create room
                    return firebase.database().ref(`users/${currentUser.uid}/tarneebChallenges/${challengeId}`).once('value');
                })
                .then(snapshot => {
                    const challenge = snapshot.val();
                    const opponentId = String(challenge.from) === String(currentUser.uid) ? challenge.to : challenge.from;
                    const opponentName = String(challenge.from) === String(currentUser.uid) ? challenge.toName : challenge.fromName;
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©
                    const roomId = 'TR_' + challengeId;
                    const roomData = {
                        id: roomId,
                        name: `Ø·Ø±Ù†ÙŠØ¨ - ØªØ­Ø¯ÙŠ`,
                        gameType: 'tarneeb',
                        maxRounds: 1,
                        status: 'waiting',
                        creatorId: challenge.from,
                        players: [
                            {
                                id: challenge.from,
                                username: challenge.fromName,
                                name: challenge.fromName,
                                score: 0,
                                ready: true,
                                team: 0
                            },
                            {
                                id: challenge.to,
                                username: challenge.toName,
                                name: challenge.toName,
                                score: 0,
                                ready: true,
                                team: challenge.mode === 'team' ? 0 : 1
                            }
                        ],
                        invitedPlayers: [],
                        isPrivate: true,
                        mode: challenge.mode,
                        createdAt: Date.now()
                    };
                    
                    return firebase.database().ref('rooms/' + roomId).set(roomData).then(() => roomId);
                })
                .then(roomId => {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØºØ±ÙØ©
                    location.href = `room-tarneeb.html?room=${roomId}`;
                })
                .catch(err => {
                    console.error("Error accepting challenge:", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£");
                });
        }

        function rejectChallenge(challengeId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØŸ')) return;

            firebase.database().ref(`users/${currentUser.uid}/tarneebChallenges/${challengeId}`).once('value')
                .then(snapshot => {
                    const challenge = snapshot.val();
                    const opponentId = String(challenge.from) === String(currentUser.uid) ? challenge.to : challenge.from;
                    
                    // Remove from both users
                    const updates = {};
                    updates[`users/${currentUser.uid}/tarneebChallenges/${challengeId}`] = null;
                    updates[`users/${opponentId}/tarneebChallenges/${challengeId}`] = null;
                    
                    return firebase.database().ref().update(updates);
                })
                .then(() => {
                    loadChallenges();
                })
                .catch(err => {
                    console.error("Error rejecting challenge:", err);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£");
                });
        }

        function continueGame(challengeId) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠ
            const roomId = 'TR_' + challengeId;
            location.href = `room-tarneeb.html?room=${roomId}`;
        }
    </script>
</body>
</html>
