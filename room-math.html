<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® ØºØ±ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .game-box {
            width: 100%;
            max-width: 900px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #2575fc;
            font-size: 28px;
        }

        .room-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .round-indicator {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
        }

        /* Leaderboard */
        .leaderboard {
            margin: 20px 0;
        }

        .leaderboard-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .player-row {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .player-row:hover {
            transform: translateX(-5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .player-row.me {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border: 2px solid #667eea;
        }

        .player-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .player-rank.gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b6914;
        }

        .player-rank.silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #4a4a4a;
        }

        .player-rank.bronze {
            background: linear-gradient(135deg, #cd7f32, #e3a857);
            color: #5c3d1f;
        }

        .player-rank.normal {
            background: #dee2e6;
            color: #333;
        }

        .player-name {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
        }

        .player-score {
            font-size: 24px;
            font-weight: bold;
            color: #2575fc;
            margin-left: 10px;
        }

        .player-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            margin-right: 10px;
        }

        .player-status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .player-status.answered {
            background: #d4edda;
            color: #155724;
        }

        /* Question */
        .question {
            font-size: 48px;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
            text-align: center;
            min-height: 60px;
        }

        input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        input:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.1);
        }

        button {
            width: 100%;
            padding: 15px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #1c5ed6;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        button.start {
            background: #28a745;
        }

        .waiting-message {
            text-align: center;
            padding: 40px;
            background: #fff3cd;
            border-radius: 10px;
            margin: 20px 0;
        }

        .winner-box {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .winner-box.win {
            background: #d4edda;
            color: #155724;
        }

        .winner-box.normal {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>

<div class="game-box">
    <h2>ğŸ® ØºØ±ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>

    <div class="room-info">
        <h3 id="roomName">ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h3>
        <div class="round-indicator" id="roundIndicator">Ø§Ù„Ø¬ÙˆÙ„Ø© 0 / 5</div>
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard">
        <div class="leaderboard-title">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <div id="leaderboardList"></div>
    </div>

    <!-- Game Area -->
    <div id="gameArea" style="display:none;">
        <div class="question" id="questionBox">...</div>
        <input type="number" id="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§">
        <button id="submitBtn" onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <div id="winnerBox" class="winner-box" style="display:none;"></div>
    </div>

    <!-- Waiting Area -->
    <div id="waitingArea" class="waiting-message">
        <h3>â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø´Ø¦ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</h3>
        <button id="startBtn" class="start" onclick="startGame()" style="display:none; max-width:300px; margin:20px auto;">
            ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        </button>
    </div>

    <button class="secondary" onclick="location.href='rooms.html'">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØºØ±Ù</button>
</div>

<!-- ğŸ”¥ Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>

<!-- ğŸ”¥ Ù…Ù„Ù firebase-data.js Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ù„Ø¯ÙˆØ§Ù„ -->
<script src="firebase-data.js"></script>

<script>

// ğŸ”¥ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Firebase - Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… API_URL Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†

let me = JSON.parse(localStorage.getItem("user"));
if (!me) location.href = "login.html";

let params = new URLSearchParams(location.search);
let roomId = params.get("room");

let room = null;
let currentQuestion = null;
let isCalculating = false; // âœ… Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨

// =========================================
// ğŸ”¥ ØªÙˆÙ„ÙŠØ¯ Ø³Ø¤Ø§Ù„
// =========================================
function generateQuestion() {
    let a = Math.floor(Math.random() * 20) + 1;
    let b = Math.floor(Math.random() * 20) + 1;
    let ops = ["+", "-", "*"];
    let op = ops[Math.floor(Math.random() * 3)];
    let question = `${a} ${op} ${b}`;
    let answer = eval(question);
    return { question, answer };
}

// =========================================
// ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ© Ù…Ù† Firebase (Real-time)
// =========================================
function loadRoom() {
    const roomRef = firebase.database().ref('rooms/' + roomId);
    
    roomRef.on('value', snapshot => {
        const data = snapshot.val();
        if (!data) {
            showToast("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!", "error");
            setTimeout(() => location.href = "rooms.html", 2000);
            return;
        }

        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†
        room = data;
        room.id = roomId; // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ID
        
        // âœ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª - Ø§Ø­Ø°Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù„ÙŠ Ù…Ø´ IDs
        if (room.answers && typeof room.answers === 'object') {
            let playerIds = room.players.map(p => String(p.id));
            let cleanAnswers = {};
            
            Object.keys(room.answers).forEach(key => {
                if (playerIds.includes(String(key))) {
                    cleanAnswers[String(key)] = room.answers[key];
                }
            });
            
            room.answers = cleanAnswers;
        }
        
        $("#roomName").text(room.name);
        $("#roundIndicator").text(`Ø§Ù„Ø¬ÙˆÙ„Ø© ${room.currentRound || 0} / ${room.maxRounds}`);

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        if (room.players) {
            room.players.sort((a, b) => (b.score || 0) - (a.score || 0));
        }

        displayLeaderboard();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ù„Ù…Ù†Ø´Ø¦ ÙÙ‚Ø·
        if (room.status === 'waiting' && room.creatorId === String(me.id)) {
            $("#startBtn").show();
        }

        if (room.status === 'waiting') {
            $("#waitingArea").show();
            $("#gameArea").hide();
        } else if (room.status === 'playing') {
            $("#waitingArea").hide();
            $("#gameArea").show();
            
            if (!room.currentQuestion) {
                $("#questionBox").html("â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯...");
                
                // Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠÙˆÙ„Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„
                if (room.creatorId === String(me.id)) {
                    // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ù†Ø§ Ù„Ù… Ù†ÙˆÙ„Ø¯ Ø³Ø¤Ø§Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©
                    if (!window.generatingQuestion) {
                        window.generatingQuestion = true;
                        console.log("ğŸ¯ Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠÙˆÙ„Ø¯ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬ÙˆÙ„Ø©", room.currentRound);
                        
                        let q = generateQuestion();
                        roomRef.update({
                            currentQuestion: q,
                            answers: {}
                        }).then(() => {
                            console.log("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ­ÙØ¸Ù‡:", q.question);
                            window.generatingQuestion = false;
                        }).catch(err => {
                            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„:", err);
                            window.generatingQuestion = false;
                        });
                    }
                } else {
                    console.log("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø´Ø¦ Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø¬ÙˆÙ„Ø©", room.currentRound);
                }
            } else {
                displayQuestion();
                
                // âœ… Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠØªØ­Ù‚Ù‚ Ø¯ÙˆØ±ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ø§Ø¨
                if (room.creatorId === String(me.id) && !isCalculating) {
                    let allAnswered = room.players.every(p => room.answers && room.answers[String(p.id)]);
                    if (allAnswered && room.players.length > 0) {
                        console.log("âœ… Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ø§Ø¨ØŒ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...");
                        isCalculating = true;
                        calculateScores();
                    }
                }
            }
        } else if (room.status === 'finished') {
            location.href = "room-results.html?room=" + roomId;
        }
    }, err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©:", err);
    });
}

// =========================================
// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨
// =========================================
function displayLeaderboard() {
    let container = $("#leaderboardList").html("");
    
    room.players.forEach((player, index) => {
        let rank = index + 1;
        let rankClass = 'normal';
        let trophy = '';

        if (rank === 1) {
            rankClass = 'gold';
            trophy = 'ğŸ‘‘';
        } else if (rank === 2) {
            rankClass = 'silver';
            trophy = 'ğŸ¥ˆ';
        } else if (rank === 3) {
            rankClass = 'bronze';
            trophy = 'ğŸ¥‰';
        }

        let isMe = player.id === String(me.id);
        let rowClass = isMe ? 'player-row me' : 'player-row';

        let status = '';
        if (room.status === 'playing' && room.answers) {
            if (room.answers[player.id]) {
                status = '<span class="player-status answered">âœ… Ø£Ø¬Ø§Ø¨</span>';
            } else {
                status = '<span class="player-status waiting">â³ ÙŠÙ†ØªØ¸Ø±</span>';
            }
        }

        container.append(`
            <div class="${rowClass}">
                <div class="player-rank ${rankClass}">${trophy || rank}</div>
                <div class="player-name">${player.username} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
                ${status}
                <div class="player-score">${player.score || 0}</div>
            </div>
        `);
    });
}

// =========================================
// ğŸ”¥ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
// =========================================
function startGame() {
    showConfirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ", () => {
        room.status = 'playing';
        room.currentRound = 1;
        
        let q = generateQuestion();
        room.currentQuestion = q;
        room.answers = {};
    
        saveRoom();
    });
}

// =========================================
// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
// =========================================
function displayQuestion() {
    if (!room.currentQuestion) {
        $("#questionBox").html("â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...");
        return;
    }
    
    console.log("ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„:", room.currentQuestion.question, "Ù„Ù„Ø¬ÙˆÙ„Ø©", room.currentRound);
    $("#questionBox").text(room.currentQuestion.question);

    if (room.answers && room.answers[String(me.id)]) {
        $("#answer").prop("disabled", true);
        $("#submitBtn").prop("disabled", true);
        console.log("âœ… Ù„Ù‚Ø¯ Ø£Ø¬Ø¨Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„");
    } else {
        $("#answer").prop("disabled", false);
        $("#submitBtn").prop("disabled", false);
        $("#answer").val("");
        console.log("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¬Ø§Ø¨ØªÙƒ...");
    }
}

// =========================================
// ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ Firebase
// =========================================
function submitAnswer() {
    let myAnswer = $("#answer").val().trim();
    if (!myAnswer) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©!", "warning");
        return;
    }

    $("#answer").prop("disabled", true);
    $("#submitBtn").prop("disabled", true);

    // âœ… Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Firebase
    getRoom(roomId).then(latestRoom => {
        latestRoom.answers = latestRoom.answers || {};
        latestRoom.answers[String(me.id)] = {
            answer: Number(myAnswer),
            time: Date.now()
        };

        // âœ… Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase
        return updateRoom(roomId, latestRoom);
    }).then(() => {
        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        return getRoom(roomId);
    }).then(updatedRoom => {
        room = updatedRoom;
        // ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ loadRoom Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†
    }).catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:", err);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©!", "error");
        $("#answer").prop("disabled", false);
        $("#submitBtn").prop("disabled", false);
    });
}

// =========================================
// ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
// =========================================
function calculateScores() {
    console.log("ğŸ“Š Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¬ÙˆÙ„Ø©", room.currentRound);
    
    // âœ… Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹
    getRoom(roomId).then(latestRoom => {
        let correctAnswer = latestRoom.currentQuestion.answer;
        let correctPlayers = [];
        let fastestTime = Infinity;
        let fastestPlayer = null;

        // Ø­Ø³Ø§Ø¨ Ù…Ù† Ø£Ø¬Ø§Ø¨ ØµØ­
        latestRoom.players.forEach(player => {
            let playerAnswer = latestRoom.answers[player.id];
            if (playerAnswer && playerAnswer.answer === correctAnswer) {
                correctPlayers.push(player.id);
                player.score = (player.score || 0) + 1;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø±Ø¹
                if (playerAnswer.time < fastestTime) {
                    fastestTime = playerAnswer.time;
                    fastestPlayer = player.id;
                }
            }
        });

        // Ù†Ù‚Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø³Ø±Ø¹
        if (fastestPlayer && correctPlayers.length > 1) {
            let player = latestRoom.players.find(p => p.id === fastestPlayer);
            if (player) player.score += 1;
        }

        console.log("âœ… Ø§Ù„Ù†ØªØ§Ø¦Ø¬:", correctPlayers.length, "Ù„Ø§Ø¹Ø¨ Ø£Ø¬Ø§Ø¨ ØµØ­");

        // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        let resultMsg = correctPlayers.length > 0 ? 
            `âœ… ${correctPlayers.length} Ù„Ø§Ø¹Ø¨ Ø£Ø¬Ø§Ø¨ ØµØ­! Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØµØ­ÙŠØ­: ${correctAnswer}` : 
            `âŒ Ù„Ø§ Ø£Ø­Ø¯ Ø£Ø¬Ø§Ø¨ ØµØ­! Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØµØ­ÙŠØ­: ${correctAnswer}`;
        
        $("#winnerBox").html(resultMsg).show();

        // âœ… Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        return new Promise(resolve => {
            setTimeout(() => {
                $("#winnerBox").hide();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
                if (latestRoom.currentRound >= latestRoom.maxRounds) {
                    latestRoom.status = 'finished';
                    latestRoom.currentQuestion = null;
                    latestRoom.answers = {};
                    console.log("ğŸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!");
                } else {
                    latestRoom.currentRound += 1;
                    latestRoom.currentQuestion = null;
                    latestRoom.answers = {};
                    console.log("â¡ï¸ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¬ÙˆÙ„Ø©", latestRoom.currentRound);
                }
                
                resolve(latestRoom);
            }, 2000);
        });
    }).then(latestRoom => {
        // âœ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Firebase
        return updateRoom(roomId, latestRoom);
    }).then(() => {
        console.log("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù„Ù‰ Firebase");
        
        // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±Ø§Ù‹
        isCalculating = false;
        window.generatingQuestion = false; // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙˆÙ„ÙŠØ¯ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
        
        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        return getRoom(roomId);
    }).then(updatedRoom => {
        if (updatedRoom.status === 'finished') {
            console.log("ğŸ ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
            setTimeout(() => {
                location.href = "room-results.html?room=" + roomId;
            }, 1000);
        } else {
            console.log("ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© - Ø¬ÙˆÙ„Ø©", updatedRoom.currentRound);
            console.log("ğŸ“Œ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:", updatedRoom.currentQuestion);
            
            // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ù†Ø´Ø¦ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ØŒ ÙˆÙ„Ù‘Ø¯ ÙˆØ§Ø­Ø¯ ÙÙˆØ±Ø§Ù‹
            if (updatedRoom.creatorId === String(me.id) && !updatedRoom.currentQuestion) {
                console.log("ğŸš€ Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠÙˆÙ„Ø¯ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø¬ÙˆÙ„Ø©", updatedRoom.currentRound);
                let q = generateQuestion();
                
                firebase.database().ref('rooms/' + roomId).update({
                    currentQuestion: q,
                    answers: {}
                }).then(() => {
                    console.log("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", q.question);
                });
            }
        }
    }).catch(err => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:", err);
        isCalculating = false;
        window.generatingQuestion = false;
    });
}

// =========================================
// ğŸ”¥ Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firebase
// =========================================
function saveRoom(callback) {
    updateRoom(roomId, room).then(() => {
        if (callback) callback();
    }).catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ©:", err);
    });
}

// ==============================
// ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
// ==============================
loadRoom();

// =========================================
// ğŸ¨ UI Helper Functions
// =========================================
function showConfirm(message, onConfirm) {
    if (confirm(message)) {
        onConfirm();
    }
}

function showAlert(message) {
    alert(message);
}

function showToast(message, type = 'info') {
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        font-weight: 600;
        animation: slideDown 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100px); opacity: 0; }
    }
`;
document.head.appendChild(styleSheet);

</script>

</body>
</html>