<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ® ØºØ±ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .game-box {
            width: 100%;
            max-width: 900px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
            color: #2575fc;
            font-size: 28px;
        }

        .room-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .round-indicator {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin: 10px 0;
        }

        /* Leaderboard */
        .leaderboard {
            margin: 20px 0;
        }

        .leaderboard-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .player-row {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .player-row:hover {
            transform: translateX(-5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .player-row.me {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border: 2px solid #667eea;
        }

        .player-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .player-rank.gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #8b6914;
        }

        .player-rank.silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #4a4a4a;
        }

        .player-rank.bronze {
            background: linear-gradient(135deg, #cd7f32, #e3a857);
            color: #5c3d1f;
        }

        .player-rank.normal {
            background: #dee2e6;
            color: #333;
        }

        .player-name {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
        }

        .player-score {
            font-size: 24px;
            font-weight: bold;
            color: #2575fc;
            margin-left: 10px;
        }

        .player-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            margin-right: 10px;
        }

        .player-status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .player-status.answered {
            background: #d4edda;
            color: #155724;
        }

        /* Question */
        .question {
            font-size: 48px;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
            text-align: center;
            min-height: 60px;
        }

        input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        input:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.1);
        }

        button {
            width: 100%;
            padding: 15px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #1c5ed6;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        button.start {
            background: #28a745;
        }

        .waiting-message {
            text-align: center;
            padding: 40px;
            background: #fff3cd;
            border-radius: 10px;
            margin: 20px 0;
        }

        .winner-box {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .winner-box.win {
            background: #d4edda;
            color: #155724;
        }

        .winner-box.normal {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>

<div class="game-box">
    <h2>ğŸ® ØºØ±ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>

    <div class="room-info">
        <h3 id="roomName">ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h3>
        <div class="round-indicator" id="roundIndicator">Ø§Ù„Ø¬ÙˆÙ„Ø© 0 / 5</div>
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard">
        <div class="leaderboard-title">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <div id="leaderboardList"></div>
    </div>

    <!-- Game Area -->
    <div id="gameArea" style="display:none;">
        <div class="question" id="questionBox">...</div>
        <input type="number" id="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§">
        <button id="submitBtn" onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <div id="winnerBox" class="winner-box" style="display:none;"></div>
    </div>

    <!-- Waiting Area -->
    <div id="waitingArea" class="waiting-message">
        <h3>â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø´Ø¦ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</h3>
        <button id="startBtn" class="start" onclick="startGame()" style="display:none; max-width:300px; margin:20px auto;">
            ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        </button>
    </div>

    <button class="secondary" onclick="location.href='rooms.html'">Ø±Ø¬ÙˆØ¹ Ù„Ù„ØºØ±Ù</button>
</div>

<!-- ğŸ”¥ Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>

<!-- ğŸ”¥ Ù…Ù„Ù firebase-data.js Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ù„Ø¯ÙˆØ§Ù„ -->
<script src="firebase-data.js"></script>

<script>

// ğŸ”¥ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Firebase - Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… API_URL Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†

let me = JSON.parse(localStorage.getItem("user"));
if (!me) location.href = "login.html";

let params = new URLSearchParams(location.search);
let roomId = params.get("room");

let room = null;
let currentQuestion = null;
let isCalculating = false; // âœ… Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨

// =========================================
// ğŸ”¥ ØªÙˆÙ„ÙŠØ¯ Ø³Ø¤Ø§Ù„
// =========================================
function generateQuestion() {
    let a = Math.floor(Math.random() * 20) + 1;
    let b = Math.floor(Math.random() * 20) + 1;
    let ops = ["+", "-", "*"];
    let op = ops[Math.floor(Math.random() * 3)];
    let question = `${a} ${op} ${b}`;
    let answer = eval(question);
    return { question, answer };
}

// =========================================
// ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ© Ù…Ù† Firebase
// =========================================
function loadRoom() {
    getRoom(roomId).then(data => {
        if (!data) {
            alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
            location.href = "rooms.html";
            return;
        }

        room = data;
        
        // âœ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª - Ø§Ø­Ø°Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù„ÙŠ Ù…Ø´ IDs
        if (room.answers && typeof room.answers === 'object') {
            let playerIds = room.players.map(p => String(p.id));
            let cleanAnswers = {};
            
            Object.keys(room.answers).forEach(key => {
                if (playerIds.includes(String(key))) {
                    cleanAnswers[String(key)] = room.answers[key];
                }
            });
            
            room.answers = cleanAnswers;
        }
        
        $("#roomName").text(room.name);
        $("#roundIndicator").text(`Ø§Ù„Ø¬ÙˆÙ„Ø© ${room.currentRound || 0} / ${room.maxRounds}`);

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        room.players.sort((a, b) => (b.score || 0) - (a.score || 0));

        displayLeaderboard();

        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ù„Ù…Ù†Ø´Ø¦ ÙÙ‚Ø·
        if (room.status === 'waiting' && room.creatorId === String(me.id)) {
            $("#startBtn").show();
        }

        if (room.status === 'waiting') {
            $("#waitingArea").show();
            $("#gameArea").hide();
        } else if (room.status === 'playing') {
            $("#waitingArea").hide();
            $("#gameArea").show();
            
            if (!room.currentQuestion) {
                // Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠÙˆÙ„Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„
                if (room.creatorId === String(me.id)) {
                    let q = generateQuestion();
                    room.currentQuestion = q;
                    room.answers = {};
                    saveRoom();
                }
            } else {
                displayQuestion();
            }
        } else if (room.status === 'finished') {
            location.href = "room-results.html?room=" + roomId;
        }
    }).catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©:", err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©!");
    });
}

// =========================================
// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨
// =========================================
function displayLeaderboard() {
    let container = $("#leaderboardList").html("");
    
    room.players.forEach((player, index) => {
        let rank = index + 1;
        let rankClass = 'normal';
        let trophy = '';

        if (rank === 1) {
            rankClass = 'gold';
            trophy = 'ğŸ‘‘';
        } else if (rank === 2) {
            rankClass = 'silver';
            trophy = 'ğŸ¥ˆ';
        } else if (rank === 3) {
            rankClass = 'bronze';
            trophy = 'ğŸ¥‰';
        }

        let isMe = player.id === String(me.id);
        let rowClass = isMe ? 'player-row me' : 'player-row';

        let status = '';
        if (room.status === 'playing' && room.answers) {
            if (room.answers[player.id]) {
                status = '<span class="player-status answered">âœ… Ø£Ø¬Ø§Ø¨</span>';
            } else {
                status = '<span class="player-status waiting">â³ ÙŠÙ†ØªØ¸Ø±</span>';
            }
        }

        container.append(`
            <div class="${rowClass}">
                <div class="player-rank ${rankClass}">${trophy || rank}</div>
                <div class="player-name">${player.username} ${isMe ? '(Ø£Ù†Øª)' : ''}</div>
                ${status}
                <div class="player-score">${player.score || 0}</div>
            </div>
        `);
    });
}

// =========================================
// ğŸ”¥ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
// =========================================
function startGame() {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ")) return;

    room.status = 'playing';
    room.currentRound = 1;
    
    let q = generateQuestion();
    room.currentQuestion = q;
    room.answers = {};

    saveRoom();
}

// =========================================
// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
// =========================================
function displayQuestion() {
    if (!room.currentQuestion) return;
    
    $("#questionBox").text(room.currentQuestion.question);

    if (room.answers && room.answers[String(me.id)]) {
        $("#answer").prop("disabled", true);
        $("#submitBtn").prop("disabled", true);
    } else {
        $("#answer").prop("disabled", false);
        $("#submitBtn").prop("disabled", false);
    }
}

// =========================================
// ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ Firebase
// =========================================
function submitAnswer() {
    let myAnswer = $("#answer").val().trim();
    if (!myAnswer) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©!");
        return;
    }

    $("#answer").prop("disabled", true);
    $("#submitBtn").prop("disabled", true);

    // âœ… Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Firebase
    getRoom(roomId).then(latestRoom => {
        latestRoom.answers = latestRoom.answers || {};
        latestRoom.answers[String(me.id)] = {
            answer: Number(myAnswer),
            time: Date.now()
        };

        // âœ… Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase
        return updateRoom(roomId, latestRoom);
    }).then(() => {
        // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        return getRoom(roomId);
    }).then(updatedRoom => {
        room = updatedRoom;
        checkAllAnswered();
    }).catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:", err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©!");
        $("#answer").prop("disabled", false);
        $("#submitBtn").prop("disabled", false);
    });
}

// =========================================
// ğŸ”¥ ÙØ­Øµ Ø¥Ø°Ø§ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ø§Ø¨
// =========================================
function checkAllAnswered() {
    setTimeout(() => {
        // âœ… Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Firebase
        getRoom(roomId).then(data => {
            room = data;
            
            if (!room.answers) return;
            
            // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            let allAnswered = room.players.every(p => room.answers[String(p.id)]);
            
            if (allAnswered && room.creatorId === String(me.id)) {
                isCalculating = true; // âœ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                calculateScores();
            }
        }).catch(err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:", err);
        });
    }, 1500); // âœ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¬Ù…ÙŠØ¹
}

// =========================================
// ğŸ”¥ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
// =========================================
function calculateScores() {
    let correctAnswer = room.currentQuestion.answer;
    let correctPlayers = [];
    let fastestTime = Infinity;
    let fastestPlayer = null;

    // Ø­Ø³Ø§Ø¨ Ù…Ù† Ø£Ø¬Ø§Ø¨ ØµØ­
    room.players.forEach(player => {
        let playerAnswer = room.answers[player.id];
        if (playerAnswer && playerAnswer.answer === correctAnswer) {
            correctPlayers.push(player.id);
            player.score = (player.score || 0) + 1;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø±Ø¹
            if (playerAnswer.time < fastestTime) {
                fastestTime = playerAnswer.time;
                fastestPlayer = player.id;
            }
        }
    });

    // Ù†Ù‚Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø³Ø±Ø¹
    if (fastestPlayer && correctPlayers.length > 1) {
        let player = room.players.find(p => p.id === fastestPlayer);
        if (player) player.score += 1;
    }

    // Ø§Ù„ØªØ§Ù„ÙŠ
    if (room.currentRound >= room.maxRounds) {
        room.status = 'finished';
        room.currentQuestion = null;
        room.answers = {};
    } else {
        room.currentRound += 1;
        room.currentQuestion = null;
        room.answers = {};
    }

    // âœ… Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase Ø£ÙˆÙ„Ø§Ù‹
    saveRoom(() => {
        if (room.status === 'finished') {
            location.href = "room-results.html?room=" + roomId;
        } else {
            // âœ… Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… ÙˆÙ„Ù‘Ø¯ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
            setTimeout(() => {
                getRoom(roomId).then(updatedRoom => {
                    room = updatedRoom;
                    
                    // Ø§Ù„Ù…Ù†Ø´Ø¦ ÙŠÙˆÙ„Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    if (!room.currentQuestion && room.creatorId === String(me.id)) {
                        let q = generateQuestion();
                        room.currentQuestion = q;
                        room.answers = {};
                        saveRoom(() => {
                            isCalculating = false; // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        });
                    } else {
                        isCalculating = false; // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                    }
                }).catch(err => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±ÙØ©:", err);
                    isCalculating = false;
                });
            }, 1500);
        }
    });
}

// =========================================
// ğŸ”¥ Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© ÙÙŠ Firebase
// =========================================
function saveRoom(callback) {
    updateRoom(roomId, room).then(() => {
        if (callback) callback();
    }).catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ©:", err);
    });
}

// ==============================
// ğŸ¯ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Firebase
// ==============================
setInterval(function() {
    if (!room || room.status !== 'finished') {
        if (!isCalculating) { // âœ… ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø´ Ø¨Ù†Ø­Ø³Ø¨
            loadRoom();
        }
    }
}, 2000);

loadRoom();

</script>

</body>
</html>